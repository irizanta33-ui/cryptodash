<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>CryptoDash Pro â€” CoinCap Edition</title>
  <style>
    body{margin:0;font-family:sans-serif;background:#0f172a;color:#e2e8f0}
    header{display:flex;justify-content:space-between;align-items:center;padding:1rem;background:#1e293b}
    h1{margin:0;font-size:1.2rem}
    main{padding:1rem}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{padding:0.6rem;text-align:left;border-bottom:1px solid #334155}
    tr:hover{background:#1e293b;cursor:pointer}
    .muted{color:#94a3b8;font-size:0.9rem}
    #detail{display:none}
    #chart{height:480px}
    button{padding:0.4rem 0.8rem;border:0;border-radius:6px;background:#334155;color:white;cursor:pointer}
    button:hover{background:#475569}
  </style>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
  <header>
    <h1>ðŸ“Š CryptoDash Pro</h1>
    <button onclick="showList()">Home</button>
  </header>

  <main>
    <!-- List -->
    <section id="list">
      <h2>Top Markets (CoinCap)</h2>
      <table>
        <thead>
          <tr><th>#</th><th>Name</th><th>Price (USD)</th><th>24h %</th><th>Market Cap</th></tr>
        </thead>
        <tbody id="marketBody"></tbody>
      </table>
    </section>

    <!-- Detail -->
    <section id="detail">
      <h2 id="coinTitle">Detail</h2>
      <div id="chart"></div>
      <p id="coinInfo" class="muted"></p>
    </section>
  </main>

<script>
const API = "https://api.coincap.io/v2";

// wrapper fetch via allorigins
async function proxyFetch(url){
  const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
  const data = await res.json();
  return JSON.parse(data.contents);
}

// LIST
async function loadMarket(){
  try {
    const result = await proxyFetch(`${API}/assets?limit=20`);
    const tbody = document.getElementById("marketBody");
    tbody.innerHTML="";
    result.data.forEach((c,i)=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${i+1}</td>
                    <td>${c.name} (${c.symbol})</td>
                    <td>$${parseFloat(c.priceUsd).toFixed(2)}</td>
                    <td style="color:${c.changePercent24Hr>=0?'#4ade80':'#f87171'}">${parseFloat(c.changePercent24Hr).toFixed(2)}%</td>
                    <td>$${(c.marketCapUsd/1e9).toFixed(2)}B</td>`;
      tr.onclick=()=>showDetail(c.id,c.name);
      tbody.appendChild(tr);
    });
  } catch(e){
    alert("Gagal memuat pasar: "+e);
  }
}

// DETAIL
async function showDetail(id,name){
  document.getElementById("list").style.display="none";
  document.getElementById("detail").style.display="block";
  document.getElementById("coinTitle").textContent=name;

  try {
    // get coin detail
    const info = await proxyFetch(`${API}/assets/${id}`);
    const coin = info.data;

    // get history
    const history = await proxyFetch(`${API}/assets/${id}/history?interval=d1`);
    const candles = history.data.map(p=>({
      time: Math.floor(new Date(p.time).getTime()/1000),
      value: +p.priceUsd
    }));

    // draw chart
    document.getElementById("chart").innerHTML="";
    const chart = LightweightCharts.createChart(document.getElementById("chart"),{
      layout:{background:{color:'#0f172a'},textColor:'#e2e8f0'},
      grid:{vertLines:{color:'#1e293b'},horzLines:{color:'#1e293b'}},
      timeScale:{borderColor:'#334155'},rightPriceScale:{borderColor:'#334155'}
    });
    const lineSeries = chart.addLineSeries({color:"#4ade80"});
    lineSeries.setData(candles);

    document.getElementById("coinInfo").textContent =
      `Rank: ${coin.rank} â€¢ Price: $${parseFloat(coin.priceUsd).toFixed(2)} â€¢ Supply: ${Number(coin.supply).toFixed(0)} â€¢ Market Cap: $${(coin.marketCapUsd/1e9).toFixed(2)}B`;
  } catch(e){
    alert("Gagal memuat detail: "+e);
  }
}

function showList(){
  document.getElementById("detail").style.display="none";
  document.getElementById("list").style.display="block";
}

loadMarket();
</script>
</body>
</html>
