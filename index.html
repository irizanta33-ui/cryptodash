<!--
CryptoDash+TV - Single-file static HTML for GitHub Pages
Now with Candlestick chart like TradingView.
-->

<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CryptoDash+TV â€” Market Explorer</title>
  <link rel="icon" href="data:," />
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#00d1b2;--danger:#ff6b6b;--glass: rgba(255,255,255,0.03)}
    [data-theme='light']{--bg:#f5f7fa;--card:#ffffff;--muted:#475569;--accent:#0f766e;--danger:#d94660;--glass: rgba(15,23,42,0.03)}
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#071024);color:#e6eef6}
    .container{max-width:1200px;margin:24px auto;padding:16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#60a5fa);display:flex;align-items:center;justify-content:center;font-weight:700;color:#042;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    h1{font-size:20px;margin:0}
    .controls{display:flex;gap:8px;align-items:center}
    input[type='search'],select,button{padding:8px 12px;border-radius:10px;border:0;background:var(--card);color:inherit}
    .card{background:var(--card);border-radius:14px;padding:12px;margin-top:16px;box-shadow:0 6px 30px rgba(2,6,23,0.55)}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:10px;text-align:left}
    thead th{color:var(--muted);font-weight:600;font-size:12px}
    tbody tr{border-top:1px solid rgba(255,255,255,0.03)}
    .price{font-weight:700}
    .spark{width:120px;height:36px}
    .pill{display:inline-block;padding:6px 8px;border-radius:999px;background:var(--glass);font-size:12px}
    .muted{color:var(--muted)}
    .actions{display:flex;gap:8px}
    .fav{cursor:pointer}
    .footer{margin-top:16px;color:var(--muted);font-size:13px;display:flex;justify-content:space-between}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:16px;background:rgba(0,0,0,0.6)}
    .modal.show{display:flex}
    .modal .panel{max-width:1000px;width:100%;background:var(--card);border-radius:14px;padding:16px}
    .small{font-size:12px}
    #tvchart{height:480px;width:100%}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
  <div class="container" id="app">
    <header>
      <div class="brand">
        <div class="logo">CD</div>
        <div>
          <h1>CryptoDash+TV</h1>
          <div class="muted small">Market explorer with candlestick charts</div>
        </div>
      </div>
      <div class="controls">
        <input id="search" type="search" placeholder="Cari koin" />
        <select id="currency"><option value="usd">USD</option><option value="idr">IDR</option><option value="btc">BTC</option></select>
        <select id="perPage"><option>10</option><option selected>25</option><option>50</option><option>100</option></select>
        <button id="themeBtn">ðŸŒ™</button>
        <button id="refresh">â†»</button>
      </div>
    </header>

    <section class="card">
      <table>
        <thead>
          <tr><th>#</th><th>Name</th><th>Price</th><th>24h %</th><th>Market Cap</th><th>Sparkline</th><th>Actions</th></tr>
        </thead>
        <tbody id="coinsTbody"></tbody>
      </table>
      <div class="footer"><span class="muted">Data: CoinGecko</span><span class="muted">Favorites: <span id="favCount">0</span></span></div>
    </section>

    <div id="modal" class="modal">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 id="modalTitle">Coin</h3>
          <button id="closeModal">Close</button>
        </div>
        <div id="tvchart"></div>
        <div id="modalInfo" class="muted small"></div>
      </div>
    </div>
  </div>

<script>
const CONFIG={COINGECKO_API_KEY:'',BASE:'https://api.coingecko.com/api/v3'}
let state={page:1,perPage:25,vs_currency:'usd',coins:[],favorites:new Set(JSON.parse(localStorage.getItem('cd:favs')||'[]'))}
const $=s=>document.querySelector(s)

function apiFetch(path,params={}){const url=new URL(CONFIG.BASE+path);Object.entries(params).forEach(([k,v])=>url.searchParams.set(k,v));const h=CONFIG.COINGECKO_API_KEY?{'x-cg-pro-api-key':CONFIG.COINGECKO_API_KEY}:{ };return fetch(url,{headers:h}).then(r=>r.json())}

async function loadCoins(){const data=await apiFetch('/coins/markets',{vs_currency:state.vs_currency,order:'market_cap_desc',per_page:state.perPage,page:state.page,sparkline:true,price_change_percentage:'24h'});state.coins=data;renderTable()}
function fmt(n){if(!n)return'â€”';if(n>1e9)return(n/1e9).toFixed(2)+'B';if(n>1e6)return(n/1e6).toFixed(2)+'M';if(n>1e3)return(n/1e3).toFixed(2)+'k';return n}
function renderTable(){const tb=$('#coinsTbody');tb.innerHTML='';state.coins.forEach((c,i)=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${i+1}</td><td><img src="${c.image}" width=20 style="vertical-align:middle;border-radius:6px"/> ${c.name}<div class='muted small'>${c.symbol.toUpperCase()}</div></td><td>${c.current_price.toLocaleString()}</td><td style=color:${c.price_change_percentage_24h>=0?'#4ade80':'#ff8383'}>${c.price_change_percentage_24h?.toFixed(2)}%</td><td>${fmt(c.market_cap)}</td><td><canvas class='spark' data-idx='${i}'></canvas></td><td><span class='pill fav' data-id='${c.id}'>${state.favorites.has(c.id)?'â˜…':'â˜†'}</span> <button class='detail' data-id='${c.id}'>Detail</button></td>`;tb.appendChild(tr)});document.querySelectorAll('.fav').forEach(b=>b.onclick=toggleFav);document.querySelectorAll('.detail').forEach(b=>b.onclick=e=>openDetail(e.target.dataset.id));$('#favCount').textContent=state.favorites.size;document.querySelectorAll('.spark').forEach(cv=>{const coin=state.coins[cv.dataset.idx];if(!coin.sparkline_in_7d)return;new Chart(cv.getContext('2d'),{type:'line',data:{labels:coin.sparkline_in_7d.price.map((_,i)=>i),datasets:[{data:coin.sparkline_in_7d.price,borderWidth:1,pointRadius:0}]},options:{plugins:{legend:{display:false}},scales:{x:{display:false},y:{display:false}}}})})}
function toggleFav(e){const id=e.target.dataset.id;if(state.favorites.has(id))state.favorites.delete(id);else state.favorites.add(id);localStorage.setItem('cd:favs',JSON.stringify([...state.favorites]));renderTable()}

let chart
async function openDetail(id){$('#modal').classList.add('show');$('#modalTitle').textContent='Loadingâ€¦';const data=await apiFetch(`/coins/${id}/ohlc`,{vs_currency:state.vs_currency,days:7});$('#modalTitle').textContent=id.toUpperCase();$('#modalInfo').textContent=`OHLC datapoints: ${data.length}`;
 if(chart) chart.remove(); chart=LightweightCharts.createChart(document.getElementById('tvchart'),{layout:{background:{color:'transparent'},textColor:'#ccc'},grid:{vertLines:{color:'#2a2e39'},horzLines:{color:'#2a2e39'}},timeScale:{borderColor:'#555'},rightPriceScale:{borderColor:'#555'}});
 const candleSeries=chart.addCandlestickSeries();
 candleSeries.setData(data.map(p=>({time:p[0]/1000,open:p[1],high:p[2],low:p[3],close:p[4]})));
}
$('#closeModal').onclick=()=>$('#modal').classList.remove('show')
$('#refresh').onclick=loadCoins
$('#currency').onchange=e=>{state.vs_currency=e.target.value;loadCoins()}
$('#perPage').onchange=e=>{state.perPage=+e.target.value;loadCoins()}
$('#themeBtn').onclick=()=>{document.documentElement.toggleAttribute('data-theme','light')}
loadCoins()
</script>
</body>
</html>
