<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VrizCoinDash</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:Arial, sans-serif;background:#f9fafc;margin:0;padding:0;color:#333}
    header{background:#111;color:#fff;padding:10px 20px;display:flex;align-items:center;justify-content:space-between}
    header h1{margin:0;font-size:1.2em}
    #controls{display:flex;gap:10px;flex-wrap:wrap}
    #market-list{padding:20px}
    .coin{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #ddd;padding:8px 0;cursor:pointer}
    .coin img{width:20px;height:20px;margin-right:8px}
    .coin-name{display:flex;align-items:center}
    #detail{padding:20px;display:none}
    .loading{text-align:center;padding:20px}
    button{cursor:pointer;padding:6px 12px;border-radius:6px;border:1px solid #aaa;background:#fff}
    button:hover{background:#eee}
    select,input{padding:6px}
    .small{font-size:0.85em;}
  </style>
</head>
<body>
  <header>
    <h1>VrizCoinDash</h1>
    <div id="controls">
      <button onclick="showList()">Market</button>
      <button onclick="showFavs()">Favorites</button>
      <input id="search" placeholder="Search" oninput="filterList()" />
      <select id="order" onchange="changeOrder(this.value)">
        <option value="market_cap_desc">Market Cap ↓</option>
        <option value="market_cap_asc">Market Cap ↑</option>
        <option value="volume_desc">Volume ↓</option>
        <option value="volume_asc">Volume ↑</option>
      </select>
    </div>
  </header>
  <div id="market-list"></div>
  <div id="detail">
    <button onclick="backToList()">← Back</button>
    <h2 id="detail-title"></h2>
    <canvas id="chart" height="100"></canvas>
    <div id="detail-info"></div>
  </div>
  <script>
    const API_ROOT='https://api.coingecko.com/api/v3';
    let page=1,perPage=20,order='market_cap_desc',vs_currency='usd';
    const els={list:document.getElementById('market-list'),detail:document.getElementById('detail'),detailTitle:document.getElementById('detail-title'),detailInfo:document.getElementById('detail-info'),search:document.getElementById('search')};

    async function fetchMarkets(){
      els.list.innerHTML='';
      const q=new URLSearchParams({vs_currency,order,per_page:perPage,page,sparkline:'false'}).toString();
      try{
        const res=await fetch(`${API_ROOT}/coins/markets?${q}`);
        if(!res.ok) throw new Error('Network response not ok');
        const data=await res.json();
        localStorage.setItem('vriz_cache', JSON.stringify({time:Date.now(), data}));
        renderMarkets(data);
      }catch(e){
        console.error(e);
        const cache=localStorage.getItem('vriz_cache');
        if(cache){
          const {time,data}=JSON.parse(cache);
          renderMarkets(data);
          const msg=document.createElement('div');
          msg.className='small';
          msg.style.color='orange';
          msg.style.marginBottom='8px';
          msg.textContent=`⚠️ Data dari cache (${new Date(time).toLocaleTimeString()}) karena gagal fetch: ${e.message}`;
          els.list.prepend(msg);
        }else{
          els.list.innerHTML=`<div class="loading">Gagal memuat pasar — ${e.message}</div>`;
        }
      }
    }

    function renderMarkets(data){
      els.list.innerHTML='';
      data.forEach(c=>{
        const div=document.createElement('div');
        div.className='coin';
        div.innerHTML=`<div class="coin-name"><img src="${c.image}"/>${c.name} (${c.symbol.toUpperCase()})</div><div>$${c.current_price.toLocaleString()}</div>`;
        div.onclick=()=>showDetail(c.id);
        els.list.appendChild(div);
      });
    }

    async function showDetail(id){
      els.list.style.display='none';
      els.detail.style.display='block';
      els.detailTitle.textContent='Loading...';
      els.detailInfo.innerHTML='';
      try{
        const [coin,mkt]=await Promise.all([
          fetch(`${API_ROOT}/coins/${id}`).then(r=>r.json()),
          fetch(`${API_ROOT}/coins/${id}/market_chart?vs_currency=${vs_currency}&days=7`).then(r=>r.json())
        ]);
        els.detailTitle.textContent=`${coin.name} (${coin.symbol.toUpperCase()})`;
        els.detailInfo.innerHTML=`<p>Current Price: $${coin.market_data.current_price[vs_currency]}</p>`;
        renderChart(mkt.prices);
      }catch(e){
        els.detailTitle.textContent='Error loading detail';
      }
    }

    function renderChart(prices){
      const ctx=document.getElementById('chart').getContext('2d');
      new Chart(ctx,{type:'line',data:{labels:prices.map(p=>new Date(p[0]).toLocaleDateString()),datasets:[{label:'Price',data:prices.map(p=>p[1])}]}});
    }

    function backToList(){els.detail.style.display='none';els.list.style.display='block';}
    function showList(){els.detail.style.display='none';els.list.style.display='block';fetchMarkets();}
    function showFavs(){alert('Favorites not implemented yet')}
    function changeOrder(o){order=o;fetchMarkets();}
    function filterList(){const q=els.search.value.toLowerCase();document.querySelectorAll('.coin').forEach(div=>{div.style.display=div.textContent.toLowerCase().includes(q)?'flex':'none'});}

    fetchMarkets();
  </script>
</body>
</html>
