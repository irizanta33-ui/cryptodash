<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VrizCoinDash</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:Arial, sans-serif;background:#0d1117;color:#e6edf3;margin:0;padding:0}
    header{background:#161b22;color:#fff;padding:15px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10}
    header h1{margin:0;font-size:1.3em;color:#58a6ff}
    #controls{display:flex;gap:10px;flex-wrap:wrap}
    #controls button,#controls select,#controls input{background:#21262d;color:#e6edf3;border:1px solid #30363d;border-radius:6px;padding:6px 10px}
    #controls button:hover{background:#30363d}
    #market-list{padding:20px;display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:15px}
    .coin{background:#161b22;padding:15px;border:1px solid #30363d;border-radius:12px;cursor:pointer;transition:transform .2s, box-shadow .2s}
    .coin:hover{transform:translateY(-3px);box-shadow:0 4px 12px rgba(0,0,0,.4)}
    .coin-header{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .coin-header img{width:28px;height:28px}
    .coin-name{font-weight:bold;font-size:1.05em}
    .coin-price{font-size:1.1em;margin:5px 0}
    .coin-change.up{color:#3fb950}
    .coin-change.down{color:#f85149}
    #detail{padding:20px;display:none}
    #detail h2{margin-top:0;color:#58a6ff}
    canvas{background:#fff;border-radius:8px;padding:10px}
    .loading{text-align:center;padding:20px}
    .small{font-size:0.85em;color:orange;margin-bottom:8px}
  </style>
</head>
<body>
  <header>
    <h1>VrizCoinDash</h1>
    <div id="controls">
      <button onclick="showList()">Market</button>
      <button onclick="showFavs()">Favorites</button>
      <input id="search" placeholder="Search" oninput="filterList()" />
      <select id="order" onchange="changeOrder(this.value)">
        <option value="market_cap_desc">Market Cap ↓</option>
        <option value="market_cap_asc">Market Cap ↑</option>
        <option value="volume_desc">Volume ↓</option>
        <option value="volume_asc">Volume ↑</option>
      </select>
    </div>
  </header>

  <div id="market-list"></div>
  <div id="detail">
    <button onclick="backToList()">← Back</button>
    <h2 id="detail-title"></h2>
    <canvas id="chart" height="120"></canvas>
    <div id="detail-info"></div>
  </div>

  <script>
    const API_ROOT='https://api.coingecko.com/api/v3';
    const PROXY='https://corsproxy.io/?';
    let page=1,perPage=20,order='market_cap_desc',vs_currency='usd';
    const els={list:document.getElementById('market-list'),detail:document.getElementById('detail'),detailTitle:document.getElementById('detail-title'),detailInfo:document.getElementById('detail-info'),search:document.getElementById('search')};

    async function safeFetch(url){
      try{
        const res=await fetch(url);
        if(!res.ok) throw new Error(res.status);
        return res;
      }catch(e){
        console.warn('Direct fetch failed, trying proxy',e);
        return fetch(PROXY+url);
      }
    }

    async function fetchMarkets(){
      els.list.innerHTML='<div class="loading">Loading...</div>';
      const q=new URLSearchParams({vs_currency,order,per_page:perPage,page,sparkline:'false'}).toString();
      try{
        const res=await safeFetch(`${API_ROOT}/coins/markets?${q}`);
        if(!res.ok) throw new Error('Error '+res.status);
        const data=await res.json();
        localStorage.setItem('vriz_cache', JSON.stringify({time:Date.now(), data}));
        renderMarkets(data);
      }catch(e){
        console.error(e);
        const cache=localStorage.getItem('vriz_cache');
        if(cache){
          const {time,data}=JSON.parse(cache);
          renderMarkets(data);
          const msg=document.createElement('div');
          msg.className='small';
          msg.textContent=`⚠️ Data dari cache (${new Date(time).toLocaleTimeString()}) karena gagal fetch: ${e.message}`;
          els.list.prepend(msg);
        }else{
          els.list.innerHTML=`<div class="loading">Gagal memuat pasar — ${e.message}</div>`;
        }
      }
    }

    function renderMarkets(data){
      els.list.innerHTML='';
      data.forEach(c=>{
        const div=document.createElement('div');
        div.className='coin';
        const change=c.price_change_percentage_24h;
        div.innerHTML=`
          <div class="coin-header">
            <img src="${c.image}" alt="${c.name}"/>
            <div class="coin-name">${c.name} (${c.symbol.toUpperCase()})</div>
          </div>
          <div class="coin-price">$${c.current_price.toLocaleString()}</div>
          <div class="coin-change ${change>=0?'up':'down'}">${change?change.toFixed(2):0}%</div>
        `;
        div.onclick=()=>showDetail(c.id);
        els.list.appendChild(div);
      });
    }

    async function showDetail(id){
      els.list.style.display='none';
      els.detail.style.display='block';
      els.detailTitle.textContent='Loading...';
      els.detailInfo.innerHTML='';
      try{
        const [coin,mkt]=await Promise.all([
          safeFetch(`${API_ROOT}/coins/${id}`).then(r=>r.json()),
          safeFetch(`${API_ROOT}/coins/${id}/market_chart?vs_currency=${vs_currency}&days=7`).then(r=>r.json())
        ]);
        els.detailTitle.textContent=`${coin.name} (${coin.symbol.toUpperCase()})`;
        els.detailInfo.innerHTML=`<p>Current Price: $${coin.market_data.current_price[vs_currency]}</p>`;
        renderChart(mkt.prices);
      }catch(e){
        els.detailTitle.textContent='Error loading detail';
      }
    }

    function renderChart(prices){
      const ctx=document.getElementById('chart').getContext('2d');
      new Chart(ctx,{type:'line',data:{labels:prices.map(p=>new Date(p[0]).toLocaleDateString()),datasets:[{label:'Price',data:prices.map(p=>p[1]),borderColor:'#58a6ff',backgroundColor:'rgba(88,166,255,.1)'}]},options:{plugins:{legend:{labels:{color:'#e6edf3'}}},scales:{x:{ticks:{color:'#e6edf3'}},y:{ticks:{color:'#e6edf3'}}}}});
    }

    function backToList(){els.detail.style.display='none';els.list.style.display='grid';}
    function showList(){els.detail.style.display='none';els.list.style.display='grid';fetchMarkets();}
    function showFavs(){alert('Favorites not implemented yet')}
    function changeOrder(o){order=o;fetchMarkets();}
    function filterList(){const q=els.search.value.toLowerCase();document.querySelectorAll('.coin').forEach(div=>{div.style.display=div.textContent.toLowerCase().includes(q)?'block':'none'});}

    fetchMarkets();
  </script>
</body>
</html>
