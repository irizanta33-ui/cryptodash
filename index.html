<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CryptoDash Pro ‚Äî CoinCap + Proxy (GitHub Pages)</title>
<link rel="icon" href="data:," />
<style>
  :root{--bg:#071026;--panel:#07182a;--muted:#98a4b2;--accent:#00d1b2;--danger:#ff6b6b;--glass:rgba(255,255,255,0.02)}
  *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto}
  body{margin:0;background:linear-gradient(180deg,var(--bg),#021021);color:#e6eef6}
  .wrap{max-width:1200px;margin:18px auto;padding:16px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#60a5fa);display:flex;align-items:center;justify-content:center;font-weight:700;color:#042}
  .controls{display:flex;gap:8px;align-items:center}
  input,select,button{padding:8px 12px;border-radius:10px;border:0;background:var(--panel);color:inherit}
  main{margin-top:16px}
  .card{background:var(--panel);padding:12px;border-radius:12px;box-shadow:0 6px 30px rgba(2,6,23,0.6)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;text-align:left}
  thead th{color:var(--muted);font-size:12px}
  .muted{color:var(--muted)}
  .spark{width:120px;height:36px}
  .pill{display:inline-block;padding:6px 8px;border-radius:999px;background:var(--glass);cursor:pointer}
  .grid{display:grid;grid-template-columns:1fr 420px;gap:16px}
  @media (max-width:980px){.grid{grid-template-columns:1fr} .logo{display:none}}
  #tvchart{height:520px;width:100%}
  .range-buttons{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
  .range-buttons button.active{outline:2px solid rgba(0,209,178,0.14)}
  .indicator-toggle{display:flex;gap:12px;align-items:center;margin-bottom:8px}
  .stat{display:flex;justify-content:space-between}
  .links a{display:inline-block;margin-right:8px;color:var(--accent)}
  .empty{padding:40px;text-align:center;color:var(--muted)}
  footer{margin-top:16px;color:var(--muted);font-size:13px}
  .small{font-size:12px;color:var(--muted)}
  .error{background:#2b0710;color:#ffd4d4;padding:10px;border-radius:8px;margin:10px 0}
</style>

<!-- Chart libs -->
<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">CD</div>
        <div>
          <div style="font-weight:700;font-size:18px">CryptoDash Pro</div>
          <div class="muted small">CoinCap via CORS proxy ‚Ä¢ SPA for GitHub Pages</div>
        </div>
      </div>

      <div class="controls">
        <input id="search" placeholder="Cari koin atau symbol (bitcoin, ethereum)" />
        <select id="currency"><option value="usd">USD</option></select>
        <button id="themeBtn">üåô</button>
      </div>
    </header>

    <main id="appMain">
      <!-- LIST -->
      <section id="listPage">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div><strong id="statsCount">‚Äî</strong> <span class="muted">coins</span></div>
            <div class="muted">Watchlist: <span id="favCount">0</span></div>
          </div>

          <div id="marketError"></div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr><th>#</th><th>Name</th><th>Price (USD)</th><th>24h %</th><th>Market Cap</th><th>Spark</th><th>Actions</th></tr>
              </thead>
              <tbody id="coinsTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- DETAIL -->
      <section id="detailPage" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div style="display:flex;gap:12px;align-items:center">
            <button id="backBtn" class="pill">‚Üê Back</button>
            <h2 id="coinTitle">Coin</h2>
          </div>
          <div class="muted" id="priceNow">‚Äî</div>
        </div>

        <div class="grid">
          <div class="card">
            <div id="detailError"></div>

            <div class="range-buttons" role="tablist" aria-label="Range">
              <button data-days="1" class="rangeBtn">1D</button>
              <button data-days="7" class="rangeBtn">7D</button>
              <button data-days="30" class="rangeBtn active">30D</button>
              <button data-days="90" class="rangeBtn">90D</button>
              <button data-days="365" class="rangeBtn">1Y</button>
            </div>

            <div class="indicator-toggle">
              <label><input type="checkbox" id="smaToggle"/> SMA</label>
              <label><input type="checkbox" id="emaToggle"/> EMA</label>
              <div class="small muted">Indicators apply on current chart.</div>
            </div>

            <div id="tvchart" class="card" style="margin-top:8px;padding:8px"></div>
            <div id="chartNote" class="muted small" style="margin-top:8px">Candlestick chart ‚Äî data converted to OHLC from CoinCap history via proxy.</div>
          </div>

          <aside class="card">
            <div style="display:flex;flex-direction:column;gap:12px">
              <div>
                <strong>About</strong>
                <div id="coinDesc" class="muted small" style="margin-top:6px;max-height:160px;overflow:auto">Description not provided by CoinCap.</div>
              </div>

              <div>
                <strong>Stats</strong>
                <div class="muted small" style="margin-top:6px">
                  <div class="stat"><span>Rank</span><span id="coinRank">‚Äî</span></div>
                  <div class="stat"><span>Market Cap</span><span id="coinMarketCap">‚Äî</span></div>
                  <div class="stat"><span>24h Volume</span><span id="coinVolume">‚Äî</span></div>
                  <div class="stat"><span>Supply</span><span id="coinSupply">‚Äî</span></div>
                  <div class="stat"><span>Price (USD)</span><span id="coinPrice">‚Äî</span></div>
                </div>
              </div>

              <div>
                <strong>Links</strong>
                <div id="coinLinks" class="muted small" style="margin-top:6px">‚Äî</div>
              </div>

              <div style="display:flex;gap:8px;margin-top:8px">
                <button id="favBtn" class="pill">‚òÜ Add to Watchlist</button>
                <button id="shareBtn" class="pill">Share</button>
              </div>
            </div>
          </aside>
        </div>
      </section>
    </main>

    <footer class="muted">Built with CoinCap & corsproxy.io ‚Ä¢ For production use a private proxy (Cloudflare Worker / Netlify function).</footer>
  </div>

<script>
/* ===== CONFIG ===== */
// Using public proxy so browser can fetch CoinCap from GitHub Pages.
// corsproxy.io usage: https://corsproxy.io/?https://api.coincap.io/v2/assets
const PROXY = 'https://corsproxy.io/?'
const API_BASE = 'https://api.coincap.io/v2'
const state = {
  coins: [],
  favorites: new Set(JSON.parse(localStorage.getItem('cd:cap:favs')||'[]')),
  current: null,
  lastChartRaw: null
}
const $ = s => document.querySelector(s)

/* ===== NETWORK (via proxy) ===== */
async function proxyFetch(path){
  // path is the full API URL (like `${API_BASE}/assets?limit=200`)
  const url = PROXY + encodeURIComponent(path)
  const res = await fetch(url)
  if(!res.ok) throw new Error(`Proxy ${res.status}`)
  const json = await res.json()
  // corsproxy.io returns the proxied body raw when successful.
  // If proxied endpoint returns JSON, json will be that JSON.
  return json
}

// convenience wrapper for CoinCap endpoints
async function coinCap(path){
  const full = `${API_BASE}${path}`
  const j = await proxyFetch(full)
  // coinCap returns { data: ..., timestamp: ... } ; but proxy returns same structure
  return j
}

/* ===== HELPERS ===== */
function fmt(n){ if(n==null) return '‚Äî'; const num = Number(n); if(isNaN(num)) return n; if(Math.abs(num)>1e12) return (num/1e12).toFixed(2)+'T'; if(Math.abs(num)>1e9) return (num/1e9).toFixed(2)+'B'; if(Math.abs(num)>1e6) return (num/1e6).toFixed(2)+'M'; if(Math.abs(num)>1e3) return (num/1e3).toFixed(2)+'k'; return num.toLocaleString() }

/* ===== LOAD MARKET (LIST) ===== */
async function loadMarket(){
  $('#marketError').innerHTML = ''
  $('#coinsTbody').innerHTML = '<tr><td colspan="7" class="muted">Loading‚Ä¶</td></tr>'
  try{
    const resp = await coinCap('/assets?limit=200') // proxied
    const list = resp && resp.data ? resp.data : []
    list.sort((a,b)=> Number(a.rank) - Number(b.rank))
    state.coins = list
    renderList(list)
    $('#statsCount').textContent = list.length
    $('#favCount').textContent = state.favorites.size
  }catch(err){
    console.error('market load', err)
    $('#marketError').innerHTML = `<div class="error">Gagal memuat pasar: ${err.message}. Jika error CORS/pemblokiran, pertimbangkan proxy yang berbeda atau server-proxy sendiri.</div>`
    $('#coinsTbody').innerHTML = '<tr><td colspan="7" class="muted">‚Äî</td></tr>'
  }
}

function renderList(list){
  const tbody = $('#coinsTbody'); tbody.innerHTML = ''
  list.forEach((c,i)=>{
    const tr = document.createElement('tr')
    const pct = c.changePercent24Hr ? Number(c.changePercent24Hr) : null
    tr.innerHTML = `
      <td style="width:48px">${c.rank ?? (i+1)}</td>
      <td style="min-width:220px"><strong>${c.name}</strong> <div class="muted small">${c.symbol}</div></td>
      <td>${Number(c.priceUsd || 0).toFixed(6)}</td>
      <td style="color:${pct>=0? '#4ade80':'#ff8383'}">${pct!==null? pct.toFixed(2)+'%':'‚Äî'}</td>
      <td class="muted">${fmt(c.marketCapUsd)}</td>
      <td><canvas class="spark" data-idx="${i}" width="120" height="36"></canvas></td>
      <td><button class="pill fav" data-id="${c.id}">${state.favorites.has(c.id)?'‚òÖ':'‚òÜ'}</button> <button class="pill" data-id="${c.id}" data-action="open">Detail</button></td>
    `
    tbody.appendChild(tr)
  })
  // listeners
  document.querySelectorAll('.pill[data-action="open"]').forEach(b=>b.onclick = e => {
    const id = e.target.dataset.id
    location.hash = '#/coin/' + id
  })
  document.querySelectorAll('.fav').forEach(b=>b.onclick = toggleFav)
  // draw decorative sparklines quickly (randomized small lines) to keep UI lively
  document.querySelectorAll('.spark').forEach(cv=>{
    const ctx = cv.getContext('2d')
    new Chart(ctx, {
      type:'line',
      data:{ labels: new Array(20).fill('').map((_,i)=>i), datasets:[{ data: new Array(20).fill(0).map(()=>Math.random()*1.2), borderWidth:1, pointRadius:0 }]},
      options:{ animation:false, plugins:{legend:{display:false}}, scales:{x:{display:false},y:{display:false}}, elements:{line:{tension:0.4}}}
    })
  })
}

/* ===== FAVORITES ===== */
function toggleFav(e){
  const id = e.target.dataset.id
  if(!id) return
  if(state.favorites.has(id)) state.favorites.delete(id)
  else state.favorites.add(id)
  localStorage.setItem('cd:cap:favs', JSON.stringify([...state.favorites]))
  document.querySelectorAll(`.fav[data-id="${id}"]`).forEach(btn => btn.textContent = state.favorites.has(id)? '‚òÖ' : '‚òÜ')
  $('#favCount').textContent = state.favorites.size
}

/* ===== ROUTER ===== */
window.addEventListener('hashchange', route)
function showList(){
  $('#detailPage').style.display = 'none'; $('#listPage').style.display = 'block'
  if(!state.coins || state.coins.length === 0) loadMarket()
  else renderList(state.coins)
  $('#favCount').textContent = state.favorites.size
}
function route(){
  const h = location.hash.replace('#','') || '/'
  if(h.startsWith('/coin/')){
    const id = h.split('/')[2]
    showDetail(id)
  } else {
    showList()
  }
}

/* ===== DETAIL & CHART ===== */
let chart = null, candleSeries = null, smaSeries = null, emaSeries = null

async function showDetail(id){
  $('#detailError').innerHTML = ''
  try{
    $('#listPage').style.display='none'; $('#detailPage').style.display='block'
    $('#coinTitle').textContent = 'Loading‚Ä¶'
    state.current = id

    // fetch metadata
    const metaResp = await coinCap(`/assets/${id}`)
    const meta = metaResp && metaResp.data ? metaResp.data : null
    if(meta){
      $('#coinTitle').textContent = `${meta.name} (${meta.symbol})`
      $('#coinRank').textContent = meta.rank || '‚Äî'
      $('#coinMarketCap').textContent = meta.marketCapUsd ? fmt(meta.marketCapUsd) : '‚Äî'
      $('#coinVolume').textContent = meta.volumeUsd24Hr ? fmt(meta.volumeUsd24Hr) : '‚Äî'
      $('#coinSupply').textContent = meta.supply ? fmt(meta.supply) : '‚Äî'
      $('#coinPrice').textContent = meta.priceUsd ? Number(meta.priceUsd).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:8}) : '‚Äî'
      $('#coinDesc').innerHTML = '<i>Description not available via CoinCap. Add CoinGecko/CoinPaprika integration for rich descriptions.</i>'
      $('#coinLinks').innerHTML = `<a href="https://coincap.io/assets/${meta.id}" target="_blank" rel="noopener noreferrer">CoinCap page</a>`
    } else {
      $('#coinTitle').textContent = id
    }

    // default range days
    const defaultDays = 30
    await loadChartRange(id, defaultDays)
    $('#favBtn').textContent = state.favorites.has(id) ? '‚òÖ In Watchlist' : '‚òÜ Add to Watchlist'
    $('#favBtn').onclick = ()=>{ if(state.favorites.has(id)) state.favorites.delete(id); else state.favorites.add(id); localStorage.setItem('cd:cap:favs', JSON.stringify([...state.favorites])); $('#favBtn').textContent = state.favorites.has(id) ? '‚òÖ In Watchlist' : '‚òÜ Add to Watchlist'; $('#favCount').textContent = state.favorites.size }
    $('#shareBtn').onclick = ()=>{ navigator.share ? navigator.share({title:meta?.name||id, text:'Lihat koin ini', url:location.href}) : prompt('Copy link', location.href) }
  }catch(e){
    console.error('detail load', e)
    $('#detailError').innerHTML = `<div class="error">Gagal muat detail: ${e.message}</div>`
    showList()
  }
}

/* Load chart for a chosen days range.
   We request CoinCap history (interval dynamic) via proxy, then bucket into OHLC candles.
*/
async function loadChartRange(id, days){
  try{
    // mark active
    document.querySelectorAll('.rangeBtn').forEach(b=>b.classList.toggle('active', Number(b.dataset.days)===Number(days)))

    const now = Date.now()
    const start = now - (days * 24 * 3600 * 1000)
    // choose interval: CoinCap supports m1,h1,d1 (m1 availability can be limited), so we prefer:
    let interval = 'd1'
    if(days <= 1) interval = 'm1'
    else if(days <= 90) interval = 'h1'
    else interval = 'd1'

    // fetch history via proxy
    // build path with proper ms timestamps: /assets/{id}/history?interval={interval}&start={start}&end={now}
    let histResp = null
    try{
      histResp = await coinCap(`/assets/${id}/history?interval=${interval}&start=${start}&end=${now}`)
    }catch(err){
      // fallback attempts
      try{ histResp = await coinCap(`/assets/${id}/history?interval=h1&start=${start}&end=${now}`) } catch(e2){ try{ histResp = await coinCap(`/assets/${id}/history?interval=d1&start=${start}&end=${now}`) } catch(e3){ histResp = null } }
    }

    const history = (histResp && histResp.data) ? histResp.data : []
    if(!history || history.length === 0){
      document.getElementById('tvchart').innerHTML = '<div class="empty">Tidak ada data historis untuk range ini.</div>'
      return
    }

    // convert to OHLC candles
    const candles = convertHistoryToOHLC(history, days)
    // store raw for indicator computation (Lightweight expects {time,open,high,low,close})
    const lcData = candles.map(c=>({ time: Math.floor(c[0]/1000), open:c[1], high:c[2], low:c[3], close:c[4] }))
    state.lastChartRaw = lcData

    renderCandles(lcData)
    if($('#smaToggle').checked) applySMA(state.lastChartRaw, 14)
    if($('#emaToggle').checked) applyEMA(state.lastChartRaw, 14)
  }catch(e){
    console.error('loadChartRange', e)
    document.getElementById('tvchart').innerHTML = `<div class="empty">Error loading chart: ${e.message}</div>`
  }
}

/* convert history points ({price, time}) into OHLC bucketed candles */
function convertHistoryToOHLC(history, days){
  // normalise points
  const pts = history.map(p => ({ t: Number(p.time), v: Number(p.price) || Number(p.priceUsd) })).filter(p=>p.t && !isNaN(p.v))
  if(pts.length === 0) return []
  // estimate spacing
  let avgDiff = 24*3600*1000
  if(pts.length > 1){
    const diffs = []
    for(let i=1;i<pts.length;i++) diffs.push(pts[i].t - pts[i-1].t)
    avgDiff = diffs.reduce((a,b)=>a+b,0)/diffs.length
  }
  // select bucket size
  let bucket = 24*3600*1000
  if(avgDiff <= 60*60*1000) bucket = 60*60*1000
  else if(avgDiff <= 6*60*60*1000) bucket = 3*60*60*1000
  if(days <= 1 && pts.length > 120) bucket = 5*60*1000

  const buckets = {}
  pts.forEach(p=>{
    const b = Math.floor(p.t / bucket) * bucket
    if(!buckets[b]) buckets[b] = []
    buckets[b].push(p.v)
  })
  const keys = Object.keys(buckets).map(k=>Number(k)).sort((a,b)=>a-b)
  return keys.map(k=>{
    const arr = buckets[k]
    return [k, arr[0], Math.max(...arr), Math.min(...arr), arr[arr.length-1]]
  })
}

/* render with Lightweight Charts */
let chartObj = null
function renderCandles(data){
  const tgt = document.getElementById('tvchart'); tgt.innerHTML = ''
  if(chartObj) chartObj.remove()
  chartObj = LightweightCharts.createChart(tgt, {
    layout:{background:{color:'transparent'},textColor:'#cfd8e3'},
    grid:{vertLines:{color:'#19303f'},horzLines:{color:'#19303f'}},
    rightPriceScale:{borderColor:'#2b5878'},
    timeScale:{borderVisible:true}
  })
  candleSeries = chartObj.addCandlestickSeries()
  candleSeries.setData(data)
  const last = data[data.length-1]
  if(last) $('#priceNow').textContent = Number(last.close).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:8})
}

/* SMA & EMA */
let smaSeries = null, emaSeries = null
function applySMA(data, period=14){
  if(!chartObj || !data || data.length < period) return
  if(smaSeries) smaSeries.remove()
  const closes = data.map(d=>d.close)
  const sma = simpleMA(closes, period)
  const smaData = sma.map((v,i)=>({ time:data[i+period-1].time, value:v })).filter(Boolean)
  smaSeries = chartObj.addLineSeries({ color:'#ffcc00', lineWidth:1.4 })
  smaSeries.setData(smaData)
}
function applyEMA(data, period=14){
  if(!chartObj || !data || data.length < period) return
  if(emaSeries) emaSeries.remove()
  const closes = data.map(d=>d.close)
  const ema = expMA(closes, period)
  const emaData = ema.map((v,i)=>({ time:data[i+period-1].time, value:v })).filter(Boolean)
  emaSeries = chartObj.addLineSeries({ color:'#00a3ff', lineWidth:1.3 })
  emaSeries.setData(emaData)
}
function removeSMA(){ if(smaSeries){ smaSeries.remove(); smaSeries=null } }
function removeEMA(){ if(emaSeries){ emaSeries.remove(); emaSeries=null } }

function simpleMA(arr, period){
  const out=[]
  for(let i=0;i<=arr.length-period;i++){
    const s = arr.slice(i,i+period).reduce((a,b)=>a+b,0)/period
    out.push(s)
  }
  return out
}
function expMA(arr, period){
  const k = 2/(period+1)
  const out=[]
  let prev = arr.slice(0,period).reduce((a,b)=>a+b,0)/period
  for(let i=period;i<arr.length;i++){
    const v = arr[i]*k + prev*(1-k)
    out.push(v); prev = v
  }
  return out
}

/* UI handlers */
$('#backBtn').onclick = ()=>{ location.hash = '/' }
$('#themeBtn').onclick = ()=>{ document.documentElement.toggleAttribute('data-theme','light') }
document.querySelectorAll('.rangeBtn').forEach(b => b.onclick = async (e)=>{
  const days = Number(e.target.dataset.days)
  if(!state.current) return
  await loadChartRange(state.current, days)
})
$('#smaToggle').onchange = ()=>{ if($('#smaToggle').checked) applySMA(state.lastChartRaw || [], 14); else removeSMA() }
$('#emaToggle').onchange = ()=>{ if($('#emaToggle').checked) applyEMA(state.lastChartRaw || [], 14); else removeEMA() }

$('#search').addEventListener('input', e=>{
  const q = e.target.value.trim().toLowerCase()
  if(!q){ renderList(state.coins); return }
  const filtered = state.coins.filter(c => c.name.toLowerCase().includes(q) || c.symbol.toLowerCase().includes(q) || c.id.toLowerCase().includes(q))
  renderList(filtered)
})
$('#shareBtn').onclick = ()=>{ navigator.share ? navigator.share({title: document.title, text:'Lihat koin', url:location.href}) : prompt('Copy link', location.href) }

/* start */
loadMarket().then(()=>{ route(); $('#favCount').textContent = state.favorites.size })

</script>
</body>
</html>
